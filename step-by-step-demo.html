<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIP712 Permit æ¼”ç¤º</title>
    <!-- å¤šä¸ªå¤‡ç”¨ethers.js CDNé“¾æ¥ï¼Œç¡®ä¿åŠ è½½æˆåŠŸ -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"
            onerror="loadBackupEthers()"></script>

    <script>
        // å¤‡ç”¨CDNåŠ è½½å‡½æ•°
        function loadBackupEthers() {
            console.log('ä¸»CDNå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
            const backupUrls = [
                'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js'
            ];

            let currentIndex = 0;

            function tryNextCDN() {
                if (currentIndex >= backupUrls.length) {
                    showEthersError();
                    return;
                }

                const script = document.createElement('script');
                script.src = backupUrls[currentIndex];
                script.onload = function() {
                    console.log('âœ… å¤‡ç”¨CDNåŠ è½½æˆåŠŸ:', backupUrls[currentIndex]);
                };
                script.onerror = function() {
                    console.log('âŒ å¤‡ç”¨CDNå¤±è´¥:', backupUrls[currentIndex]);
                    currentIndex++;
                    tryNextCDN();
                };
                document.head.appendChild(script);
            }

            tryNextCDN();
        }

        function showEthersError() {
            document.body.innerHTML = `
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; margin: 20px; border-radius: 5px; font-family: Arial, sans-serif;">
                    <h2>âŒ ethers.js åŠ è½½å¤±è´¥</h2>
                    <p>æ‰€æœ‰CDNéƒ½æ— æ³•è®¿é—®ï¼Œè¯·å°è¯•ä»¥ä¸‹è§£å†³æ–¹æ¡ˆï¼š</p>
                    <ol>
                        <li><strong>æ£€æŸ¥ç½‘ç»œè¿æ¥</strong> - ç¡®ä¿èƒ½æ­£å¸¸è®¿é—®äº’è”ç½‘</li>
                        <li><strong>åˆ·æ–°é¡µé¢</strong> - å¯èƒ½æ˜¯ä¸´æ—¶ç½‘ç»œé—®é¢˜</li>
                        <li><strong>ä½¿ç”¨VPN</strong> - å¦‚æœåœ¨æŸäº›åœ°åŒºCDNè¢«é™åˆ¶</li>
                        <li><strong>ä¸‹è½½æœ¬åœ°æ–‡ä»¶</strong> - ä» <a href="https://github.com/ethers-io/ethers.js/releases" target="_blank">GitHub</a> ä¸‹è½½ethers.js</li>
                    </ol>
                    <button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        ğŸ”„ åˆ·æ–°é¡µé¢é‡è¯•
                    </button>
                </div>
            `;
        }
    </script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .step { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; width: 300px; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; margin: 10px 0; }
        .highlight { background: yellow; padding: 2px; }
    </style>
</head>
<body>
    <h1>ğŸ¯ EIP712 Permit åŠŸèƒ½æ¼”ç¤º</h1>

    <div class="step" style="background: #f8f9fa; border-left: 4px solid #007bff;">
        <h2>ğŸ“– æ“ä½œæŒ‡å—</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h3>ğŸ”´ ä¼ ç»Ÿæ–¹å¼ï¼ˆç¬¬ä¸‰æ­¥ï¼‰</h3>
                <ul>
                    <li><strong>æˆæƒåœ°å€</strong>ï¼šå¡«å…¥ä»»æ„æœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€</li>
                    <li><strong>æ¨èåœ°å€</strong>ï¼šæµ‹è¯•åœ°å€æˆ–æœ‹å‹çš„é’±åŒ…åœ°å€</li>
                    <li><strong>æˆæƒé‡‘é¢</strong>ï¼šå¡«å…¥æ‚¨æƒ³æˆæƒçš„ä»£å¸æ•°é‡</li>
                    <li><strong>å®é™…åœºæ™¯</strong>ï¼šæˆæƒDeFiåè®®ä½¿ç”¨æ‚¨çš„ä»£å¸</li>
                    <li><strong>è´¹ç”¨</strong>ï¼šéœ€è¦æ”¯ä»˜gasè´¹ç”¨</li>
                </ul>
            </div>
            <div>
                <h3>ğŸŸ¢ EIP712æ–¹å¼ï¼ˆç¬¬å››æ­¥ï¼‰</h3>
                <ul>
                    <li><strong>æˆæƒåœ°å€</strong>ï¼šå¡«å…¥ä¸ç¬¬ä¸‰æ­¥ä¸åŒçš„åœ°å€</li>
                    <li><strong>ç­¾åæ­¥éª¤</strong>ï¼šå®Œå…¨å…è´¹ï¼Œæ— gasè´¹ç”¨</li>
                    <li><strong>æ‰§è¡Œæ­¥éª¤</strong>ï¼šç¬¬ä¸‰æ–¹ä»£ä¸ºæ‰§è¡Œï¼Œæ”¯ä»˜gas</li>
                    <li><strong>ä¼˜åŠ¿</strong>ï¼šç”¨æˆ·ä½“éªŒæ›´å¥½ï¼ŒèŠ‚çœè´¹ç”¨</li>
                    <li><strong>åº”ç”¨</strong>ï¼šDeFiåè®®çš„æ— ç¼é›†æˆ</li>
                </ul>
            </div>
        </div>
        <div class="highlight" style="background: #fff3cd; padding: 10px; margin-top: 10px;">
            <strong>ğŸ’¡ é‡è¦æç¤ºï¼š</strong>
            æˆæƒåœ°å€å¯ä»¥æ˜¯ä»»æ„æœ‰æ•ˆåœ°å€ï¼Œä¸éœ€è¦æ˜¯æ‚¨æ‹¥æœ‰çš„åœ°å€ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é€šå¸¸æ˜¯DeFiåè®®çš„åˆçº¦åœ°å€ã€‚
        </div>
    </div>
    
    <div class="step">
        <h2>ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šè¿æ¥é’±åŒ…å’Œåˆçº¦</h2>
        <button onclick="connectWallet()">è¿æ¥MetaMask</button>
        <div id="walletStatus">æœªè¿æ¥</div>
        
        <h3>åˆçº¦é…ç½®</h3>
        <input type="text" id="contractAddress" placeholder="è¾“å…¥åˆçº¦åœ°å€" value="">
        <button onclick="connectContract()">è¿æ¥åˆçº¦</button>
        <div id="contractStatus">æœªè¿æ¥</div>
    </div>

    <div class="step">
        <h2>ğŸ” ç¬¬äºŒæ­¥ï¼šæŸ¥çœ‹å½“å‰çŠ¶æ€</h2>
        <button onclick="checkTokenInfo()">æŸ¥çœ‹ä»£å¸ä¿¡æ¯</button>
        <button onclick="checkBalance()">æŸ¥çœ‹ä½™é¢</button>
        <button onclick="checkNonce()">æŸ¥çœ‹Nonce</button>
        <button onclick="showABIInfo()">æŸ¥çœ‹ABIä¿¡æ¯</button>
        <div id="tokenInfo"></div>
    </div>

    <div class="step">
        <h2>ğŸ”´ ç¬¬ä¸‰æ­¥ï¼šä¼ ç»Ÿæ–¹å¼æ¼”ç¤ºï¼ˆ2ç¬”äº¤æ˜“ï¼‰</h2>
        <p>è¿™æ˜¯ä¼ ç»Ÿçš„approve + transferFromæµç¨‹ï¼š</p>
        <div class="highlight" style="background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <strong>ğŸ“ æ“ä½œè¯´æ˜ï¼š</strong><br>
            â€¢ <strong>æˆæƒåœ°å€</strong>ï¼šå¡«å…¥æ‚¨æƒ³è¦æˆæƒçš„åœ°å€ï¼ˆå¯ä»¥æ˜¯æµ‹è¯•åœ°å€ã€æœ‹å‹åœ°å€æˆ–DeFiåˆçº¦åœ°å€ï¼‰<br>
            â€¢ <strong>æˆæƒé‡‘é¢</strong>ï¼šæ‚¨å…è®¸è¯¥åœ°å€ä½¿ç”¨çš„ä»£å¸æ•°é‡<br>
            â€¢ <strong>å®é™…åœºæ™¯</strong>ï¼šæ¯”å¦‚æˆæƒUniswapåˆçº¦ä½¿ç”¨æ‚¨çš„ä»£å¸è¿›è¡Œäº¤æ˜“
        </div>

        <label>æˆæƒåœ°å€ï¼ˆè¢«æˆæƒè€…ï¼‰ï¼š</label>
        <input type="text" id="traditionalSpender" placeholder="ä¾‹å¦‚ï¼š0x742d35Cc6634C0532925a3b8D0C9e3e0C8b0e5e1" value="0x742d35Cc6634C0532925a3b8D0C9e3e0C8b0e5e1">

        <label>æˆæƒé‡‘é¢ï¼ˆtokensï¼‰ï¼š</label>
        <input type="text" id="traditionalAmount" placeholder="ä¾‹å¦‚ï¼š1000" value="1000">

        <div>
            <button onclick="traditionalApprove()">1ï¸âƒ£ è°ƒç”¨approveï¼ˆéœ€è¦gasï¼‰</button>
            <button onclick="checkAllowance()">æ£€æŸ¥æˆæƒé¢åº¦</button>
            <button onclick="fillTestAddress('traditional')">ğŸ¯ å¡«å…¥æµ‹è¯•åœ°å€</button>
        </div>

        <div id="traditionalResult"></div>
    </div>

    <div class="step">
        <h2>ğŸŸ¢ ç¬¬å››æ­¥ï¼šEIP712æ–¹å¼æ¼”ç¤ºï¼ˆ1ç¬”äº¤æ˜“ï¼‰</h2>
        <p class="highlight">è¿™æ˜¯æ–°çš„permitæµç¨‹ï¼Œç”¨æˆ·åªéœ€è¦ç­¾åï¼Œæ— éœ€å‘é€äº¤æ˜“ï¼</p>
        <div class="highlight" style="background: #d1ecf1; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <strong>ğŸš€ EIP712ä¼˜åŠ¿ï¼š</strong><br>
            â€¢ <strong>æ­¥éª¤1</strong>ï¼šç”¨æˆ·ç­¾åï¼ˆå®Œå…¨å…è´¹ï¼Œæ— gasè´¹ç”¨ï¼‰<br>
            â€¢ <strong>æ­¥éª¤2</strong>ï¼šç¬¬ä¸‰æ–¹æ‰§è¡Œpermitï¼ˆåªéœ€1ç¬”äº¤æ˜“ï¼‰<br>
            â€¢ <strong>å¯¹æ¯”ä¼ ç»Ÿ</strong>ï¼šèŠ‚çœ1ç¬”äº¤æ˜“ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½<br>
            â€¢ <strong>å®é™…åº”ç”¨</strong>ï¼šDeFiåè®®å¯ä»¥ä»£ç”¨æˆ·æ”¯ä»˜gasè´¹ç”¨
        </div>

        <label>æˆæƒåœ°å€ï¼ˆè¢«æˆæƒè€…ï¼‰ï¼š</label>
        <input type="text" id="permitSpender" placeholder="ä¾‹å¦‚ï¼š0x1234567890123456789012345678901234567890" value="0x1234567890123456789012345678901234567890">

        <label>æˆæƒé‡‘é¢ï¼ˆtokensï¼‰ï¼š</label>
        <input type="text" id="permitAmount" placeholder="ä¾‹å¦‚ï¼š2000" value="2000">

        <div>
            <button onclick="generatePermitSignature()">1ï¸âƒ£ ç”ŸæˆEIP712ç­¾åï¼ˆå…è´¹ï¼‰</button>
            <button onclick="executePermit()">2ï¸âƒ£ æ‰§è¡Œpermitï¼ˆéœ€è¦gasï¼‰</button>
            <button onclick="fillTestAddress('permit')">ğŸ¯ å¡«å…¥æµ‹è¯•åœ°å€</button>
        </div>

        <div id="permitResult"></div>
    </div>

    <div class="step" style="background: #fff3cd; border-left: 4px solid #ffc107;">
        <h2>ğŸ” é‡è¦æ¦‚å¿µè§£é‡Š</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h3>â“ permit â‰  transfer</h3>
                <div class="code">
                    <p><strong>permitå‡½æ•°ä½œç”¨ï¼š</strong></p>
                    <p>â€¢ æˆæƒæŸä¸ªåœ°å€ä½¿ç”¨æ‚¨çš„ä»£å¸</p>
                    <p>â€¢ ç­‰åŒäº approve(spender, amount)</p>
                    <p>â€¢ ä»£å¸ä»ç„¶åœ¨æ‚¨çš„è´¦æˆ·ä¸­</p>
                    <p>â€¢ åªæ˜¯ç»™äº†åˆ«äººä½¿ç”¨æƒé™</p>
                </div>

                <h4>ğŸ”„ å®Œæ•´æµç¨‹ï¼š</h4>
                <div class="code">
                    <p>1. permit() - æˆæƒ</p>
                    <p>2. transferFrom() - å®é™…è½¬è´¦</p>
                </div>
            </div>
            <div>
                <h3>ğŸ“ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆå¤šå‚æ•°ï¼Ÿ</h3>
                <div class="code">
                    <p><strong>EIP712ç­¾åéªŒè¯éœ€è¦ï¼š</strong></p>
                    <p>â€¢ owner: éªŒè¯ç­¾åè€…èº«ä»½</p>
                    <p>â€¢ spender: ç¡®è®¤è¢«æˆæƒè€…</p>
                    <p>â€¢ value: ç¡®è®¤æˆæƒé‡‘é¢</p>
                    <p>â€¢ deadline: é˜²æ­¢ç­¾åè¢«é•¿æœŸæ»¥ç”¨</p>
                    <p>â€¢ v,r,s: ç­¾åæ•°æ®ï¼Œç”¨äºéªŒè¯</p>
                </div>

                <h4>ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶ï¼š</h4>
                <div class="code">
                    <p>â€¢ é˜²æ­¢é‡æ”¾æ”»å‡»ï¼ˆnonceï¼‰</p>
                    <p>â€¢ é˜²æ­¢è·¨é“¾æ”»å‡»ï¼ˆåŸŸåˆ†éš”ç¬¦ï¼‰</p>
                    <p>â€¢ é˜²æ­¢é•¿æœŸæ»¥ç”¨ï¼ˆdeadlineï¼‰</p>
                </div>
            </div>
        </div>
    </div>

    <div class="step">
        <h2>ğŸ“Š ç¬¬äº”æ­¥ï¼šå¯¹æ¯”ç»“æœ</h2>
        <button onclick="compareResults()">å¯¹æ¯”gasè´¹ç”¨</button>
        <button onclick="showPermitVsTransfer()">ğŸ“– æŸ¥çœ‹permit vs transferè¯¦è§£</button>
        <button onclick="showGaslessDemo()">ğŸš€ åè®®ä»£ä»˜gasæ¼”ç¤º</button>
        <button onclick="showBatchOptimization()">ğŸ“¦ æ‰“åŒ…ä¼˜åŒ–æ¼”ç¤º</button>
        <div id="comparison"></div>
    </div>

    <script>
        // æ£€æŸ¥ethers.jsæ˜¯å¦æ­£ç¡®åŠ è½½
        function checkEthersLoaded() {
            if (typeof ethers === 'undefined') {
                document.body.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; margin: 20px; border-radius: 5px;">
                        <h2>âŒ ethers.js åŠ è½½å¤±è´¥</h2>
                        <p>è¯·å°è¯•ä»¥ä¸‹è§£å†³æ–¹æ¡ˆï¼š</p>
                        <ol>
                            <li>æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                            <li>åˆ·æ–°é¡µé¢é‡è¯•</li>
                            <li>æˆ–è€…æ‰‹åŠ¨ä¸‹è½½ethers.jsæ–‡ä»¶åˆ°æœ¬åœ°</li>
                        </ol>
                        <button onclick="location.reload()">åˆ·æ–°é¡µé¢</button>
                        <hr>
                        <h3>å¤‡ç”¨CDNé“¾æ¥ï¼š</h3>
                        <p>å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·å°è¯•æ›¿æ¢HTMLä¸­çš„scriptæ ‡ç­¾ä¸ºä»¥ä¸‹ä»»ä¸€é€‰é¡¹ï¼š</p>
                        <code>&lt;script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"&gt;&lt;/script&gt;</code><br>
                        <code>&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"&gt;&lt;/script&gt;</code>
                    </div>
                `;
                return false;
            }
            return true;
        }

        let provider, signer, contract, userAddress;
        let permitSignature = null;
        let traditionalGas = 0, permitGas = 0;

        // ä»EIP712TokenABI.jsonå¯¼å…¥çš„å®Œæ•´åˆçº¦ABI
        let contractABI = [];

        // å¼‚æ­¥åŠ è½½ABIæ–‡ä»¶
        async function loadContractABI() {
            try {
                const response = await fetch('./EIP712TokenABI.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                contractABI = await response.json();
                console.log('âœ… åˆçº¦ABIåŠ è½½æˆåŠŸï¼ŒåŒ…å«', contractABI.length, 'ä¸ªå‡½æ•°/äº‹ä»¶');
                return true;
            } catch (error) {
                console.error('âŒ åŠ è½½ABIæ–‡ä»¶å¤±è´¥:', error);
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–ç‰ˆABIä½œä¸ºå¤‡ç”¨
                contractABI = [
                    "function name() view returns (string)",
                    "function symbol() view returns (string)",
                    "function decimals() view returns (uint8)",
                    "function totalSupply() view returns (uint256)",
                    "function balanceOf(address) view returns (uint256)",
                    "function allowance(address,address) view returns (uint256)",
                    "function approve(address,uint256) returns (bool)",
                    "function transfer(address,uint256) returns (bool)",
                    "function transferFrom(address,address,uint256) returns (bool)",
                    "function permit(address,address,uint256,uint256,uint8,bytes32,bytes32)",
                    "function transferWithPermit(address,address,uint256,uint256,uint8,bytes32,bytes32)",
                    "function getNonce(address) view returns (uint256)",
                    "function getDomainSeparator() view returns (bytes32)",
                    "function getPermitTypeHash() pure returns (bytes32)",
                    "function getTransferTypeHash() pure returns (bytes32)",
                    "function getPermitHash(address,address,uint256,uint256,uint256) pure returns (bytes32)",
                    "function getTransferHash(address,address,uint256,uint256,uint256) pure returns (bytes32)",
                    "function getDigest(bytes32) view returns (bytes32)",
                    "function batchTransfer(address[],uint256[]) returns (bool)",
                    "event Transfer(address indexed from, address indexed to, uint256 value)",
                    "event Approval(address indexed owner, address indexed spender, uint256 value)",
                    "event PermitUsed(address indexed owner, address indexed spender, uint256 value, uint256 nonce, uint256 deadline)",
                    "event TransferWithPermit(address indexed from, address indexed to, uint256 value, uint256 nonce, address indexed executor)"
                ];
                console.log('âš ï¸ ä½¿ç”¨å¤‡ç”¨ç®€åŒ–ABI');
                return false;
            }
        }

        // EIP712åŸŸå’Œç±»å‹å®šä¹‰
        const domain = {
            name: 'EIP712 Test Token',
            version: '1',
            chainId: 11155111, // Sepolia
            verifyingContract: '' // å°†åœ¨è¿æ¥åˆçº¦æ—¶è®¾ç½®
        };

        const types = {
            Permit: [
                { name: 'owner', type: 'address' },
                { name: 'spender', type: 'address' },
                { name: 'value', type: 'uint256' },
                { name: 'nonce', type: 'uint256' },
                { name: 'deadline', type: 'uint256' }
            ]
        };

        async function connectWallet() {
            try {
                // æ£€æŸ¥ethers.jsæ˜¯å¦å¯ç”¨
                if (typeof ethers === 'undefined') {
                    throw new Error('ethers.js æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }

                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();

                    document.getElementById('walletStatus').innerHTML =
                        `<div class="success">âœ… å·²è¿æ¥: ${userAddress}</div>`;
                } else {
                    throw new Error('è¯·å®‰è£…MetaMask');
                }
            } catch (error) {
                document.getElementById('walletStatus').innerHTML =
                    `<div class="error">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function connectContract() {
            try {
                const address = document.getElementById('contractAddress').value;
                if (!address) {
                    throw new Error('è¯·è¾“å…¥åˆçº¦åœ°å€');
                }

                document.getElementById('contractStatus').innerHTML = 'â³ æ­£åœ¨åŠ è½½åˆçº¦ABIå’Œè¿æ¥åˆçº¦...';

                // ç¡®ä¿ABIå·²åŠ è½½
                if (contractABI.length === 0) {
                    await loadContractABI();
                }

                // æ ‡å‡†åŒ–åˆçº¦åœ°å€
                const normalizedAddress = ethers.utils.getAddress(address.trim());

                contract = new ethers.Contract(normalizedAddress, contractABI, signer);
                domain.verifyingContract = normalizedAddress;

                // æµ‹è¯•åˆçº¦è¿æ¥
                const name = await contract.name();

                document.getElementById('contractStatus').innerHTML =
                    `<div class="success">âœ… å·²è¿æ¥åˆçº¦: ${name}<br>åœ°å€: ${normalizedAddress}<br>ABIå‡½æ•°æ•°é‡: ${contractABI.length}</div>`;
            } catch (error) {
                document.getElementById('contractStatus').innerHTML =
                    `<div class="error">âŒ åˆçº¦è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function checkTokenInfo() {
            try {
                const name = await contract.name();
                const symbol = await contract.symbol();
                const balance = await contract.balanceOf(userAddress);
                const nonce = await contract.getNonce(userAddress);

                document.getElementById('tokenInfo').innerHTML = `
                    <div class="success">
                        <h4>ä»£å¸ä¿¡æ¯ï¼š</h4>
                        <p>åç§°: ${name}</p>
                        <p>ç¬¦å·: ${symbol}</p>
                        <p>ä½™é¢: ${ethers.utils.formatEther(balance)} tokens</p>
                        <p>å½“å‰Nonce: ${nonce}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('tokenInfo').innerHTML =
                    `<div class="error">âŒ è·å–ä¿¡æ¯å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function checkBalance() {
            try {
                if (!contract || !userAddress) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…å’Œåˆçº¦');
                }

                const balance = await contract.balanceOf(userAddress);
                document.getElementById('tokenInfo').innerHTML = `
                    <div class="success">
                        <h4>ä½™é¢ä¿¡æ¯ï¼š</h4>
                        <p>åœ°å€: ${userAddress}</p>
                        <p>ä½™é¢: ${ethers.utils.formatEther(balance)} tokens</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('tokenInfo').innerHTML =
                    `<div class="error">âŒ æŸ¥çœ‹ä½™é¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function checkNonce() {
            try {
                if (!contract || !userAddress) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…å’Œåˆçº¦');
                }

                const nonce = await contract.getNonce(userAddress);
                document.getElementById('tokenInfo').innerHTML = `
                    <div class="success">
                        <h4>Nonceä¿¡æ¯ï¼š</h4>
                        <p>åœ°å€: ${userAddress}</p>
                        <p>å½“å‰Nonce: ${nonce}</p>
                        <p>è¯´æ˜: æ¯æ¬¡ä½¿ç”¨permitånonceä¼šè‡ªåŠ¨+1</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('tokenInfo').innerHTML =
                    `<div class="error">âŒ æŸ¥çœ‹Nonceå¤±è´¥: ${error.message}</div>`;
            }
        }

        function showABIInfo() {
            const functions = contractABI.filter(item => item.type === 'function' || typeof item === 'string');
            const events = contractABI.filter(item => item.type === 'event');

            document.getElementById('tokenInfo').innerHTML = `
                <div class="success">
                    <h4>ğŸ“‹ åˆçº¦ABIä¿¡æ¯ï¼š</h4>
                    <p>æ€»æ•°é‡: ${contractABI.length} é¡¹</p>
                    <p>å‡½æ•°æ•°é‡: ${functions.length}</p>
                    <p>äº‹ä»¶æ•°é‡: ${events.length}</p>
                    <p>ABIæ¥æº: ${contractABI.length > 30 ? 'EIP712TokenABI.jsonæ–‡ä»¶' : 'å¤‡ç”¨ç®€åŒ–ABI'}</p>

                    <h5>ğŸ”§ ä¸»è¦å‡½æ•°ï¼š</h5>
                    <div class="code" style="max-height: 200px; overflow-y: auto;">
                        ${functions.slice(0, 10).map(func => {
                            if (typeof func === 'string') {
                                return `<p>â€¢ ${func}</p>`;
                            } else {
                                return `<p>â€¢ ${func.name}(${func.inputs ? func.inputs.map(i => i.type).join(', ') : ''})</p>`;
                            }
                        }).join('')}
                        ${functions.length > 10 ? `<p>... è¿˜æœ‰ ${functions.length - 10} ä¸ªå‡½æ•°</p>` : ''}
                    </div>
                </div>
            `;
        }

        // å¡«å…¥æµ‹è¯•åœ°å€çš„è¾…åŠ©å‡½æ•°
        function fillTestAddress(type) {
            const testAddresses = [
                '0x742d35Cc6634C0532925a3b8D0C9e3e0C8b0e5e1', // æµ‹è¯•åœ°å€1
                '0x1234567890123456789012345678901234567890', // æµ‹è¯•åœ°å€2
                '0xdAC17F958D2ee523a2206206994597C13D831ec7', // USDTåˆçº¦åœ°å€ï¼ˆç¤ºä¾‹ï¼‰
                '0xA0b86a33E6441E6C7D3E4C5B4B6C7D8E9F0A1B2C', // éšæœºæµ‹è¯•åœ°å€
                '0xB1C2D3E4F5A6B7C8D9E0F1A2B3C4D5E6F7A8B9C0'  // éšæœºæµ‹è¯•åœ°å€
            ];

            if (type === 'traditional') {
                const randomAddress = testAddresses[Math.floor(Math.random() * testAddresses.length)];
                document.getElementById('traditionalSpender').value = randomAddress;
                document.getElementById('traditionalResult').innerHTML = `
                    <div style="background: #e2e3e5; padding: 10px; border-radius: 5px;">
                        âœ… å·²å¡«å…¥æµ‹è¯•åœ°å€: ${randomAddress}<br>
                        ğŸ’¡ è¿™ä¸ªåœ°å€å°†è¢«æˆæƒä½¿ç”¨æ‚¨çš„ä»£å¸
                    </div>
                `;
            } else if (type === 'permit') {
                const randomAddress = testAddresses[Math.floor(Math.random() * testAddresses.length)];
                document.getElementById('permitSpender').value = randomAddress;
                document.getElementById('permitResult').innerHTML = `
                    <div style="background: #e2e3e5; padding: 10px; border-radius: 5px;">
                        âœ… å·²å¡«å…¥æµ‹è¯•åœ°å€: ${randomAddress}<br>
                        ğŸ’¡ è¿™ä¸ªåœ°å€å°†é€šè¿‡EIP712ç­¾åè¢«æˆæƒ
                    </div>
                `;
            }
        }

        async function traditionalApprove() {
            try {
                if (!contract || !userAddress) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…å’Œåˆçº¦');
                }

                const spenderInput = document.getElementById('traditionalSpender').value;
                const amount = document.getElementById('traditionalAmount').value;

                // æ ‡å‡†åŒ–åœ°å€
                const spender = ethers.utils.getAddress(spenderInput.trim());
                const amountWei = ethers.utils.parseEther(amount);

                document.getElementById('traditionalResult').innerHTML = 'â³ æ­£åœ¨æ‰§è¡Œapproveäº¤æ˜“...';

                const tx = await contract.approve(spender, amountWei);
                const receipt = await tx.wait();
                traditionalGas = receipt.gasUsed.toNumber();

                document.getElementById('traditionalResult').innerHTML = `
                    <div class="success">
                        <h4>âœ… ApproveæˆåŠŸï¼</h4>
                        <p>äº¤æ˜“å“ˆå¸Œ: ${tx.hash}</p>
                        <p>Gasä½¿ç”¨: ${traditionalGas}</p>
                        <p>æˆæƒç»™: ${spender}</p>
                        <p class="highlight">æ³¨æ„ï¼šè¿™åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œå®é™…ä½¿ç”¨è¿˜éœ€è¦transferFrom</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('traditionalResult').innerHTML =
                    `<div class="error">âŒ Approveå¤±è´¥: ${error.message}</div>`;
            }
        }

        async function generatePermitSignature() {
            try {
                if (!contract || !userAddress) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…å’Œåˆçº¦');
                }

                const spenderInput = document.getElementById('permitSpender').value;
                const amount = document.getElementById('permitAmount').value;

                // æ ‡å‡†åŒ–åœ°å€
                const spender = ethers.utils.getAddress(spenderInput.trim());
                const amountWei = ethers.utils.parseEther(amount);
                const nonce = await contract.getNonce(userAddress);
                const deadline = Math.floor(Date.now() / 1000) + 3600; // 1å°æ—¶åè¿‡æœŸ

                const value = {
                    owner: userAddress,
                    spender: spender,
                    value: amountWei.toString(),
                    nonce: nonce.toNumber(),
                    deadline: deadline
                };

                document.getElementById('permitResult').innerHTML = 'â³ è¯·åœ¨MetaMaskä¸­ç¡®è®¤ç­¾å...';

                // ç”ŸæˆEIP712ç­¾å
                const signature = await signer._signTypedData(domain, types, value);
                const sig = ethers.utils.splitSignature(signature);

                permitSignature = {
                    owner: userAddress,
                    spender: spender,
                    value: amountWei,
                    deadline: deadline,
                    v: sig.v,
                    r: sig.r,
                    s: sig.s
                };

                document.getElementById('permitResult').innerHTML = `
                    <div class="success">
                        <h4>âœ… ç­¾åç”ŸæˆæˆåŠŸï¼</h4>
                        <p class="highlight">ğŸ‰ è¿™ä¸€æ­¥å®Œå…¨å…è´¹ï¼Œæ²¡æœ‰gasè´¹ç”¨ï¼</p>
                        <div class="code">
                            <p>æˆæƒç»™: ${spender}</p>
                            <p>é‡‘é¢: ${ethers.utils.formatEther(amountWei)} tokens</p>
                            <p>v: ${sig.v}</p>
                            <p>r: ${sig.r}</p>
                            <p>s: ${sig.s}</p>
                        </div>
                        <p>ç°åœ¨å¯ä»¥æ‰§è¡Œpermitäº†</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('permitResult').innerHTML =
                    `<div class="error">âŒ ç­¾åå¤±è´¥: ${error.message}</div>`;
            }
        }

        async function executePermit() {
            try {
                if (!permitSignature) {
                    throw new Error('è¯·å…ˆç”Ÿæˆç­¾å');
                }

                document.getElementById('permitResult').innerHTML += `
                    <div style="background: #e2e3e5; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h4>ğŸ” Permitå‡½æ•°å‚æ•°è¯¦è§£ï¼š</h4>
                        <div class="code">
                            <p><strong>owner:</strong> ${permitSignature.owner} (ä»£å¸æ‹¥æœ‰è€…ï¼Œå³æ‚¨çš„åœ°å€)</p>
                            <p><strong>spender:</strong> ${permitSignature.spender} (è¢«æˆæƒè€…åœ°å€)</p>
                            <p><strong>value:</strong> ${ethers.utils.formatEther(permitSignature.value)} tokens (æˆæƒé‡‘é¢)</p>
                            <p><strong>deadline:</strong> ${new Date(permitSignature.deadline * 1000).toLocaleString()} (ç­¾åè¿‡æœŸæ—¶é—´)</p>
                            <p><strong>v:</strong> ${permitSignature.v} (ç­¾åå‚æ•°v)</p>
                            <p><strong>r:</strong> ${permitSignature.r} (ç­¾åå‚æ•°r)</p>
                            <p><strong>s:</strong> ${permitSignature.s} (ç­¾åå‚æ•°s)</p>
                        </div>
                        <p><strong>ğŸ¯ æ‰§è¡Œç»“æœï¼š</strong> allowance[${permitSignature.owner}][${permitSignature.spender}] = ${ethers.utils.formatEther(permitSignature.value)}</p>
                    </div>
                    <p>â³ æ­£åœ¨æ‰§è¡Œpermitäº¤æ˜“...</p>
                `;

                const tx = await contract.permit(
                    permitSignature.owner,    // ä»£å¸æ‹¥æœ‰è€…ï¼ˆæ‚¨çš„åœ°å€ï¼‰
                    permitSignature.spender,  // è¢«æˆæƒè€…åœ°å€
                    permitSignature.value,    // æˆæƒé‡‘é¢
                    permitSignature.deadline, // ç­¾åè¿‡æœŸæ—¶é—´
                    permitSignature.v,        // ç­¾åå‚æ•°v
                    permitSignature.r,        // ç­¾åå‚æ•°r
                    permitSignature.s         // ç­¾åå‚æ•°s
                );

                const receipt = await tx.wait();
                permitGas = receipt.gasUsed.toNumber();

                document.getElementById('permitResult').innerHTML += `
                    <div class="success">
                        <h4>âœ… Permitæ‰§è¡ŒæˆåŠŸï¼</h4>
                        <p>äº¤æ˜“å“ˆå¸Œ: ${tx.hash}</p>
                        <p>Gasä½¿ç”¨: ${permitGas}</p>
                        <p class="highlight">ğŸ¯ å®é™…æ•ˆæœï¼šç­‰åŒäºè°ƒç”¨ approve(${permitSignature.spender}, ${ethers.utils.formatEther(permitSignature.value)})</p>
                        <p><strong>é‡è¦ï¼š</strong>è¿™ä¸æ˜¯è½¬è´¦ï¼Œè€Œæ˜¯æˆæƒï¼ä»£å¸ä»åœ¨æ‚¨çš„è´¦æˆ·ä¸­ã€‚</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('permitResult').innerHTML +=
                    `<div class="error">âŒ Permitæ‰§è¡Œå¤±è´¥: ${error.message}</div>`;
            }
        }

        async function checkAllowance() {
            try {
                if (!contract || !userAddress) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…å’Œåˆçº¦');
                }

                let spender = document.getElementById('traditionalSpender').value.trim();

                // ä¿®å¤åœ°å€æ ¡éªŒå’Œé—®é¢˜
                if (spender) {
                    try {
                        // ä½¿ç”¨ethers.jsçš„getAddresså‡½æ•°æ¥æ ‡å‡†åŒ–åœ°å€æ ¼å¼
                        spender = ethers.utils.getAddress(spender);
                    } catch (addressError) {
                        throw new Error(`æ— æ•ˆçš„åœ°å€æ ¼å¼: ${spender}`);
                    }
                } else {
                    throw new Error('è¯·è¾“å…¥æˆæƒåœ°å€');
                }

                const allowance = await contract.allowance(userAddress, spender);

                document.getElementById('traditionalResult').innerHTML += `
                    <div class="success">
                        <p>âœ… å½“å‰æˆæƒé¢åº¦: ${ethers.utils.formatEther(allowance)} tokens</p>
                        <p>æˆæƒç»™: ${spender}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('traditionalResult').innerHTML += `
                    <div class="error">âŒ æ£€æŸ¥æˆæƒå¤±è´¥: ${error.message}</div>
                `;
                console.error('æ£€æŸ¥æˆæƒå¤±è´¥:', error);
            }
        }

        function compareResults() {
            const comparison = `
                <div class="success">
                    <h3>ğŸ“Š Gasè´¹ç”¨å¯¹æ¯”ç»“æœ</h3>
                    <table style="width:100%; border-collapse: collapse;">
                        <tr style="background:#f8f9fa;">
                            <th style="border:1px solid #ddd; padding:8px;">æ–¹å¼</th>
                            <th style="border:1px solid #ddd; padding:8px;">æ­¥éª¤</th>
                            <th style="border:1px solid #ddd; padding:8px;">Gasè´¹ç”¨</th>
                            <th style="border:1px solid #ddd; padding:8px;">ç”¨æˆ·ä½“éªŒ</th>
                        </tr>
                        <tr>
                            <td style="border:1px solid #ddd; padding:8px;">ğŸ”´ ä¼ ç»Ÿæ–¹å¼</td>
                            <td style="border:1px solid #ddd; padding:8px;">approve + transferFrom</td>
                            <td style="border:1px solid #ddd; padding:8px;">${traditionalGas} + ~51,000 â‰ˆ ${traditionalGas + 51000}</td>
                            <td style="border:1px solid #ddd; padding:8px;">éœ€è¦2ç¬”äº¤æ˜“</td>
                        </tr>
                        <tr>
                            <td style="border:1px solid #ddd; padding:8px;">ğŸŸ¢ EIP712æ–¹å¼</td>
                            <td style="border:1px solid #ddd; padding:8px;">ç­¾å + permit</td>
                            <td style="border:1px solid #ddd; padding:8px;">0 + ${permitGas} = ${permitGas}</td>
                            <td style="border:1px solid #ddd; padding:8px;">åªéœ€1æ¬¡ç­¾å</td>
                        </tr>
                        <tr style="background:#d4edda;">
                            <td style="border:1px solid #ddd; padding:8px;"><strong>èŠ‚çœ</strong></td>
                            <td style="border:1px solid #ddd; padding:8px;"><strong>-</strong></td>
                            <td style="border:1px solid #ddd; padding:8px;"><strong>${(traditionalGas + 51000) - permitGas} gas</strong></td>
                            <td style="border:1px solid #ddd; padding:8px;"><strong>æ›´å¥½çš„UX</strong></td>
                        </tr>
                    </table>

                    <h4>ğŸ¯ å…³é”®ä¼˜åŠ¿ï¼š</h4>
                    <ul>
                        <li>âœ… ç”¨æˆ·åªéœ€è¦ç­¾åï¼Œæ— éœ€å‘é€äº¤æ˜“</li>
                        <li>âœ… ç¬¬ä¸‰æ–¹å¯ä»¥ä»£ä»˜gasè´¹ç”¨</li>
                        <li>âœ… å¯ä»¥æ‰¹é‡å¤„ç†å¤šä¸ªæˆæƒ</li>
                        <li>âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ</li>
                    </ul>
                </div>
            `;

            document.getElementById('comparison').innerHTML = comparison;
        }

        function showPermitVsTransfer() {
            const explanation = `
                <div class="success">
                    <h3>ğŸ” Permit vs Transfer è¯¦ç»†å¯¹æ¯”</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <h4>ğŸ” permit() å‡½æ•°</h4>
                            <div class="code">
                                <p><strong>ä½œç”¨ï¼š</strong>æˆæƒï¼ˆä¸è½¬è´¦ï¼‰</p>
                                <p><strong>ç­‰åŒäºï¼š</strong>approve(spender, amount)</p>
                                <p><strong>ç»“æœï¼š</strong>allowance[owner][spender] = amount</p>
                                <p><strong>ä»£å¸ä½ç½®ï¼š</strong>ä»åœ¨ownerè´¦æˆ·ä¸­</p>
                                <p><strong>å®é™…ç”¨é€”ï¼š</strong>ç»™äºˆä½¿ç”¨æƒé™</p>
                            </div>
                        </div>

                        <div style="background: #e7f3ff; padding: 15px; border-radius: 5px;">
                            <h4>ğŸ’¸ transfer() å‡½æ•°</h4>
                            <div class="code">
                                <p><strong>ä½œç”¨ï¼š</strong>è½¬è´¦ï¼ˆå®é™…ç§»åŠ¨ä»£å¸ï¼‰</p>
                                <p><strong>ç­‰åŒäºï¼š</strong>transfer(to, amount)</p>
                                <p><strong>ç»“æœï¼š</strong>balanceOf[from] -= amount, balanceOf[to] += amount</p>
                                <p><strong>ä»£å¸ä½ç½®ï¼š</strong>ä»fromè½¬ç§»åˆ°to</p>
                                <p><strong>å®é™…ç”¨é€”ï¼š</strong>è½¬ç§»æ‰€æœ‰æƒ</p>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ”„ å®Œæ•´çš„DeFiäº¤æ˜“æµç¨‹ï¼š</h4>
                    <div class="code">
                        <p><strong>ä¼ ç»Ÿæ–¹å¼ï¼š</strong></p>
                        <p>1. ç”¨æˆ·è°ƒç”¨ approve(Uniswap, 1000) - æˆæƒUniswapä½¿ç”¨1000ä»£å¸</p>
                        <p>2. ç”¨æˆ·åœ¨Uniswapä¸Šäº¤æ˜“ï¼ŒUniswapè°ƒç”¨ transferFrom(ç”¨æˆ·, Uniswap, 1000) - å®é™…è½¬ç§»ä»£å¸</p>
                        <br>
                        <p><strong>EIP712æ–¹å¼ï¼š</strong></p>
                        <p>1. ç”¨æˆ·ç”ŸæˆEIP712ç­¾å - ç¦»çº¿æˆæƒï¼ˆå…è´¹ï¼‰</p>
                        <p>2. Uniswapè°ƒç”¨ permit(...) - æ‰§è¡Œæˆæƒ</p>
                        <p>3. Uniswapè°ƒç”¨ transferFrom(...) - å®é™…è½¬ç§»ä»£å¸</p>
                        <p>ï¼ˆæ­¥éª¤2å’Œ3å¯ä»¥åœ¨ä¸€ç¬”äº¤æ˜“ä¸­å®Œæˆï¼‰</p>
                    </div>

                    <h4>ğŸ“ ä¸ºä»€ä¹ˆpermitéœ€è¦è¿™ä¹ˆå¤šå‚æ•°ï¼Ÿ</h4>
                    <div class="code">
                        <p><strong>owner:</strong> ä»£å¸æ‹¥æœ‰è€…åœ°å€ - éªŒè¯æ˜¯è°åœ¨æˆæƒ</p>
                        <p><strong>spender:</strong> è¢«æˆæƒè€…åœ°å€ - ç¡®è®¤æˆæƒç»™è°</p>
                        <p><strong>value:</strong> æˆæƒé‡‘é¢ - ç¡®è®¤æˆæƒå¤šå°‘</p>
                        <p><strong>deadline:</strong> è¿‡æœŸæ—¶é—´ - é˜²æ­¢ç­¾åè¢«é•¿æœŸæ»¥ç”¨</p>
                        <p><strong>v, r, s:</strong> ç­¾åæ•°æ® - è¯æ˜ç­¾åçš„çœŸå®æ€§</p>
                    </div>

                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 15px;">
                        <strong>ğŸ’¡ å…³é”®ç†è§£ï¼š</strong>
                        permitå‡½æ•°åªæ˜¯æˆæƒï¼Œä¸ä¼šè½¬ç§»ä»£å¸ã€‚å°±åƒç»™åˆ«äººä¸€å¼ æ”¯ç¥¨çš„ä½¿ç”¨æƒï¼Œä½†é’±è¿˜åœ¨æ‚¨çš„è´¦æˆ·é‡Œï¼Œåªæœ‰å½“åˆ«äººçœŸæ­£ä½¿ç”¨è¿™å¼ "æ”¯ç¥¨"æ—¶ï¼Œé’±æ‰ä¼šè½¬ç§»ã€‚
                    </div>
                </div>
            `;

            document.getElementById('comparison').innerHTML = explanation;
        }

        function showGaslessDemo() {
            const gaslessDemo = `
                <div class="success">
                    <h3>ğŸš€ åè®®ä»£ä»˜Gasæ¼”ç¤º</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                            <h4>ğŸ”´ ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜</h4>
                            <div class="code">
                                <p><strong>ç”¨æˆ·é’±åŒ…çŠ¶æ€ï¼š</strong></p>
                                <p>â€¢ 1000 USDC</p>
                                <p>â€¢ 0.05 ETH (ç”¨äºgas)</p>
                                <br>
                                <p><strong>æ“ä½œæµç¨‹ï¼š</strong></p>
                                <p>1. approve() - ç”¨æˆ·æ”¯ä»˜ ~0.002 ETH</p>
                                <p>2. deposit() - ç”¨æˆ·æ”¯ä»˜ ~0.003 ETH</p>
                                <br>
                                <p><strong>é—®é¢˜ï¼š</strong></p>
                                <p>âŒ ç”¨æˆ·å¿…é¡»æŒæœ‰ETH</p>
                                <p>âŒ æ–°ç”¨æˆ·é—¨æ§›é«˜</p>
                                <p>âŒ éœ€è¦ä¸¤æ¬¡äº¤æ˜“ç¡®è®¤</p>
                            </div>
                        </div>

                        <div style="background: #d4edda; padding: 15px; border-radius: 5px;">
                            <h4>ğŸŸ¢ EIP712ä»£ä»˜Gasæ–¹æ¡ˆ</h4>
                            <div class="code">
                                <p><strong>ç”¨æˆ·é’±åŒ…çŠ¶æ€ï¼š</strong></p>
                                <p>â€¢ 1000 USDC</p>
                                <p>â€¢ 0 ETH (ä¸éœ€è¦ETHï¼)</p>
                                <br>
                                <p><strong>æ“ä½œæµç¨‹ï¼š</strong></p>
                                <p>1. ç”¨æˆ·ç”ŸæˆEIP712ç­¾å - å…è´¹</p>
                                <p>2. åè®®æ‰§è¡Œpermit+deposit - åè®®æ”¯ä»˜gas</p>
                                <br>
                                <p><strong>ä¼˜åŠ¿ï¼š</strong></p>
                                <p>âœ… ç”¨æˆ·é›¶ETHä¹Ÿèƒ½æ“ä½œ</p>
                                <p>âœ… é™ä½æ–°ç”¨æˆ·é—¨æ§›</p>
                                <p>âœ… ä¸€æ­¥å®Œæˆæ‰€æœ‰æ“ä½œ</p>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ”§ æŠ€æœ¯å®ç°åŸç†ï¼š</h4>
                    <div class="code">
                        <p><strong>1. ç”¨æˆ·ä¾§ï¼š</strong></p>
                        <p>â€¢ ç”¨æˆ·ç”ŸæˆEIP712ç­¾åï¼ˆåŒ…å«permitä¿¡æ¯ï¼‰</p>
                        <p>â€¢ å°†ç­¾åå‘é€ç»™åè®®çš„RelayeræœåŠ¡</p>
                        <br>
                        <p><strong>2. åè®®ä¾§ï¼ˆRelayerï¼‰ï¼š</strong></p>
                        <p>â€¢ éªŒè¯ç­¾åçš„æœ‰æ•ˆæ€§</p>
                        <p>â€¢ ä½¿ç”¨åè®®çš„ETHæ”¯ä»˜gasè´¹ç”¨</p>
                        <p>â€¢ æ‰§è¡Œ permit() + ä¸šåŠ¡é€»è¾‘</p>
                        <br>
                        <p><strong>3. æˆæœ¬å›æ”¶ï¼š</strong></p>
                        <p>â€¢ ä»ç”¨æˆ·çš„ä»£å¸ä¸­æ‰£é™¤ç­‰å€¼gasè´¹ç”¨</p>
                        <p>â€¢ æˆ–è€…åè®®æ‰¿æ‹…gasæˆæœ¬ï¼ˆè¥é”€ç­–ç•¥ï¼‰</p>
                        <p>â€¢ æˆ–è€…é€šè¿‡äº¤æ˜“æ‰‹ç»­è´¹è¦†ç›–</p>
                    </div>

                    <h4>ğŸŒŸ å®é™…åº”ç”¨åœºæ™¯ï¼š</h4>
                    <div style="background: #e2e3e5; padding: 10px; border-radius: 5px;">
                        <p><strong>Uniswap V3ç¤ºä¾‹ï¼š</strong></p>
                        <p>1. ç”¨æˆ·æƒ³ç”¨1000 USDCæ¢ETHï¼Œä½†é’±åŒ…é‡Œæ²¡æœ‰ETHæ”¯ä»˜gas</p>
                        <p>2. ç”¨æˆ·ç”ŸæˆEIP712ç­¾åæˆæƒUniswapä½¿ç”¨USDC</p>
                        <p>3. Uniswapçš„Relayeræ‰§è¡Œï¼špermit + swap</p>
                        <p>4. ä»äº¤æ¢å¾—åˆ°çš„ETHä¸­æ‰£é™¤gasè´¹ç”¨</p>
                        <p>5. ç”¨æˆ·è·å¾—å‰©ä½™çš„ETH</p>
                    </div>
                </div>
            `;

            document.getElementById('comparison').innerHTML = gaslessDemo;
        }

        function showBatchOptimization() {
            const batchDemo = `
                <div class="success">
                    <h3>ğŸ“¦ æ‰“åŒ…ä¼˜åŒ–æ¼”ç¤º</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: #fff3cd; padding: 15px; border-radius: 5px;">
                            <h4>ğŸ”´ ä¼ ç»Ÿæ–¹å¼ï¼šå¤šæ¬¡äº¤æ˜“</h4>
                            <div class="code">
                                <p><strong>åœºæ™¯ï¼šç”¨æˆ·æƒ³è¦è¿›è¡Œå¤šä¸ªDeFiæ“ä½œ</strong></p>
                                <br>
                                <p><strong>æ“ä½œåºåˆ—ï¼š</strong></p>
                                <p>1. approve(Compound, 1000 USDC) - Gas: ~46,000</p>
                                <p>2. deposit(1000 USDC) - Gas: ~150,000</p>
                                <p>3. approve(Uniswap, 500 DAI) - Gas: ~46,000</p>
                                <p>4. swap(500 DAI â†’ ETH) - Gas: ~180,000</p>
                                <br>
                                <p><strong>æ€»è®¡ï¼š</strong></p>
                                <p>â€¢ 4ç¬”äº¤æ˜“</p>
                                <p>â€¢ ~422,000 gas</p>
                                <p>â€¢ 4æ¬¡ç”¨æˆ·ç¡®è®¤</p>
                                <p>â€¢ ç­‰å¾…4æ¬¡åŒºå—ç¡®è®¤</p>
                            </div>
                        </div>

                        <div style="background: #d1ecf1; padding: 15px; border-radius: 5px;">
                            <h4>ğŸŸ¢ EIP712æ‰“åŒ…ä¼˜åŒ–</h4>
                            <div class="code">
                                <p><strong>åœºæ™¯ï¼šåŒæ ·çš„DeFiæ“ä½œ</strong></p>
                                <br>
                                <p><strong>æ“ä½œåºåˆ—ï¼š</strong></p>
                                <p>1. ç”¨æˆ·ç”Ÿæˆ2ä¸ªEIP712ç­¾å - å…è´¹</p>
                                <p>2. åè®®æ‰§è¡Œæ‰¹é‡æ“ä½œï¼š</p>
                                <p>   â€¢ permit(Compound, 1000 USDC)</p>
                                <p>   â€¢ deposit(1000 USDC)</p>
                                <p>   â€¢ permit(Uniswap, 500 DAI)</p>
                                <p>   â€¢ swap(500 DAI â†’ ETH)</p>
                                <br>
                                <p><strong>æ€»è®¡ï¼š</strong></p>
                                <p>â€¢ 1ç¬”äº¤æ˜“</p>
                                <p>â€¢ ~380,000 gas (èŠ‚çœ10%)</p>
                                <p>â€¢ 1æ¬¡ç”¨æˆ·ç¡®è®¤</p>
                                <p>â€¢ ç­‰å¾…1æ¬¡åŒºå—ç¡®è®¤</p>
                            </div>
                        </div>
                    </div>

                    <h4>ğŸ”§ æ‰“åŒ…ä¼˜åŒ–çš„æŠ€æœ¯åŸç†ï¼š</h4>
                    <div class="code">
                        <p><strong>1. å¤šé‡è°ƒç”¨ï¼ˆMulticallï¼‰ï¼š</strong></p>
                        <p>â€¢ å°†å¤šä¸ªå‡½æ•°è°ƒç”¨æ‰“åŒ…åˆ°ä¸€ä¸ªäº¤æ˜“ä¸­</p>
                        <p>â€¢ å‡å°‘äº¤æ˜“å¼€é”€ï¼ˆ21,000 gas per transactionï¼‰</p>
                        <p>â€¢ åŸå­æ€§æ‰§è¡Œï¼ˆè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ï¼‰</p>
                        <br>
                        <p><strong>2. Gasä¼˜åŒ–ï¼š</strong></p>
                        <p>â€¢ å…±äº«äº¤æ˜“åŸºç¡€æˆæœ¬</p>
                        <p>â€¢ å‡å°‘çŠ¶æ€å˜æ›´çš„å­˜å‚¨æˆæœ¬</p>
                        <p>â€¢ ä¼˜åŒ–è°ƒç”¨æ ˆæ·±åº¦</p>
                        <br>
                        <p><strong>3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼š</strong></p>
                        <p>â€¢ ä¸€æ¬¡ç­¾åå®Œæˆå¤æ‚æ“ä½œ</p>
                        <p>â€¢ å‡å°‘ç­‰å¾…æ—¶é—´</p>
                        <p>â€¢ é™ä½å¤±è´¥é£é™©</p>
                    </div>

                    <h4>ğŸŒŸ å®é™…åº”ç”¨æ¡ˆä¾‹ï¼š</h4>
                    <div style="background: #e2e3e5; padding: 10px; border-radius: 5px;">
                        <p><strong>1inchèšåˆå™¨ï¼š</strong></p>
                        <p>â€¢ ç”¨æˆ·æƒ³è¦æœ€ä¼˜ä»·æ ¼äº¤æ¢ä»£å¸</p>
                        <p>â€¢ éœ€è¦åœ¨å¤šä¸ªDEXä¸Šåˆ†åˆ«æ‰§è¡Œéƒ¨åˆ†äº¤æ˜“</p>
                        <p>â€¢ ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦å¤šæ¬¡approve + å¤šæ¬¡swap</p>
                        <p>â€¢ EIP712æ–¹å¼ï¼šä¸€æ¬¡ç­¾åï¼Œ1inchæ‰§è¡Œæ‰€æœ‰æ“ä½œ</p>
                        <br>
                        <p><strong>DeFiæ”¶ç›Šå†œåœºï¼š</strong></p>
                        <p>â€¢ ç”¨æˆ·æƒ³è¦ï¼šå­˜å…¥LP â†’ è´¨æŠ¼ â†’ é¢†å–å¥–åŠ± â†’ å¤æŠ•</p>
                        <p>â€¢ ä¼ ç»Ÿæ–¹å¼ï¼š8-10ç¬”äº¤æ˜“</p>
                        <p>â€¢ EIP712æ–¹å¼ï¼š2-3ä¸ªç­¾åï¼Œ1ç¬”äº¤æ˜“å®Œæˆ</p>
                    </div>
                </div>
            `;

            document.getElementById('comparison').innerHTML = batchDemo;
        }

        // é¡µé¢åŠ è½½æ—¶çš„æ£€æŸ¥å’Œåˆå§‹åŒ–
        window.onload = async function() {
            // æ£€æŸ¥ethers.jsæ˜¯å¦åŠ è½½æˆåŠŸ
            if (!checkEthersLoaded()) {
                return;
            }

            // æ˜¾ç¤ºethers.jsç‰ˆæœ¬ä¿¡æ¯
            console.log('âœ… ethers.js åŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬:', ethers.version);

            // é¢„åŠ è½½åˆçº¦ABI
            console.log('ğŸ”„ æ­£åœ¨åŠ è½½åˆçº¦ABI...');
            const abiLoaded = await loadContractABI();

            // è®¾ç½®é»˜è®¤åˆçº¦åœ°å€æç¤º
            document.getElementById('contractAddress').value = 'è¯·åœ¨Remixä¸­éƒ¨ç½²åˆçº¦åå¡«å…¥åœ°å€';

            // æ·»åŠ æˆåŠŸåŠ è½½æç¤º
            const statusDiv = document.createElement('div');
            statusDiv.innerHTML = `
                <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; margin: 10px 0; border-radius: 5px;">
                    âœ… ethers.js v${ethers.version} åŠ è½½æˆåŠŸï¼<br>
                    ${abiLoaded ?
                        `âœ… åˆçº¦ABIåŠ è½½æˆåŠŸï¼åŒ…å« ${contractABI.length} ä¸ªå‡½æ•°/äº‹ä»¶` :
                        'âš ï¸ ABIæ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨ç®€åŒ–ABI'
                    }<br>
                    å¯ä»¥å¼€å§‹æµ‹è¯•äº†ã€‚
                </div>
            `;
            document.body.insertBefore(statusDiv, document.body.firstChild);
        };
    </script>
</body>
</html>
